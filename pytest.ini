[pytest]
# ============================================================================
# PYTEST CONFIGURATION - Retail Recommender System
# ============================================================================
# This configuration file centralizes all pytest settings for consistent
# test execution across development, CI/CD, and production environments.
#
# Author: Senior Architecture Team
# Date: 2025-10-29
# Version: 1.0.0
# ============================================================================

# ----------------------------------------------------------------------------
# ASYNC SUPPORT
# ----------------------------------------------------------------------------
# Automatically detect and handle async tests without requiring @pytest.mark.asyncio
asyncio_mode = auto

# ----------------------------------------------------------------------------
# TEST DISCOVERY
# ----------------------------------------------------------------------------
# Define where tests are located and how they should be discovered
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# ----------------------------------------------------------------------------
# OUTPUT AND REPORTING OPTIONS
# ----------------------------------------------------------------------------
addopts = 
    # Verbose output showing test names
    -v
    # Strict marker enforcement (fail on unknown markers)
    --strict-markers
    # Short traceback format (more readable)
    --tb=short
    # Coverage for src directory
    --cov=src
    # Generate HTML coverage report
    --cov-report=html
    # Show missing lines in terminal
    --cov-report=term-missing
    # Fail if coverage is below target (gradual increase during Fase 3)
    # Semana 1: 40%, Semana 2: 55%, Semana 3: 70%
    --cov-fail-under=40
    # Show extra test summary info
    -ra
    # Show warnings summary
    --strict-config

# ----------------------------------------------------------------------------
# TEST MARKERS
# ----------------------------------------------------------------------------
# Custom markers for organizing and filtering tests
markers =
    unit: Unit tests (isolated component tests)
    integration: Integration tests (multiple components)
    e2e: End-to-end tests (full system tests)
    slow: Tests that take >1 second to run
    redis: Tests requiring Redis connection
    shopify: Tests requiring Shopify API access
    google: Tests requiring Google Cloud APIs
    smoke: Quick smoke tests for CI
    skip_ci: Skip in CI/CD pipeline
    regression: Regression tests for bugs
    performance: Performance and load tests

# ----------------------------------------------------------------------------
# COVERAGE CONFIGURATION
# ----------------------------------------------------------------------------
[coverage:run]
# Source directory to measure
source = src

# Files to omit from coverage
omit = 
    */tests/*
    */test_*.py
    */__pycache__/*
    */.pytest_cache/*
    */conftest.py
    */setup.py
    */venv/*
    */env/*

# Enable branch coverage (not just line coverage)
branch = True

# ----------------------------------------------------------------------------
# COVERAGE REPORTING
# ----------------------------------------------------------------------------
[coverage:report]
# Lines to exclude from coverage reporting
exclude_lines =
    # Standard pragma
    pragma: no cover
    
    # Don't complain about missing debug code
    def __repr__
    def __str__
    
    # Don't complain if tests don't hit defensive assertion code
    raise AssertionError
    raise NotImplementedError
    
    # Don't complain about main entry points
    if __name__ == .__main__.:
    
    # Don't complain about type checking blocks
    if TYPE_CHECKING:
    if typing.TYPE_CHECKING:
    
    # Don't complain about abstract methods
    @abstract
    @abstractmethod
    
    # Don't complain about pass statements
    pass

# Show missing lines in report
show_missing = True

# Precision for coverage percentage
precision = 2

# Sort by coverage percentage (lowest first)
sort = Cover

# ----------------------------------------------------------------------------
# HTML COVERAGE REPORT
# ----------------------------------------------------------------------------
[coverage:html]
# Output directory for HTML report
directory = htmlcov

# Title for HTML report
title = Retail Recommender System - Test Coverage Report

# ----------------------------------------------------------------------------
# PYTEST-ASYNCIO CONFIGURATION
# ----------------------------------------------------------------------------
# Additional asyncio-specific settings
asyncio_default_fixture_loop_scope = function

# ----------------------------------------------------------------------------
# LOGGING CONFIGURATION
# ----------------------------------------------------------------------------
# Control log output during tests
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# File logging
log_file = tests/logs/pytest.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] [%(filename)s:%(lineno)d] %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# ----------------------------------------------------------------------------
# TIMEOUT CONFIGURATION
# ----------------------------------------------------------------------------
# Maximum time for each test (prevent hanging tests)
timeout = 300
timeout_method = thread

# ----------------------------------------------------------------------------
# PYTEST-XDIST CONFIGURATION (for parallel testing)
# ----------------------------------------------------------------------------
# These settings will be used if pytest-xdist is installed
# Run tests in parallel using auto-detection of CPU cores
# addopts = -n auto

# ----------------------------------------------------------------------------
# WARNINGS CONFIGURATION
# ----------------------------------------------------------------------------
# Control how warnings are handled
filterwarnings =
    # Treat warnings as errors (strict mode)
    error
    # Allow specific warnings
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    # Allow warnings from third-party libraries
    ignore::UserWarning:pytest
    ignore::UserWarning:_pytest

# ----------------------------------------------------------------------------
# MINIMUM VERSION REQUIREMENTS
# ----------------------------------------------------------------------------
minversion = 7.0

# ----------------------------------------------------------------------------
# CACHE CONFIGURATION
# ----------------------------------------------------------------------------
# Cache directory for pytest (speeds up reruns)
cache_dir = .pytest_cache

# ----------------------------------------------------------------------------
# NOTES AND USAGE EXAMPLES
# ----------------------------------------------------------------------------
# 
# RUNNING TESTS:
# 
# All tests:
#   pytest
# 
# Specific marker:
#   pytest -m unit
#   pytest -m "unit and not slow"
# 
# Specific file:
#   pytest tests/unit/test_service_factory.py
# 
# With coverage report:
#   pytest --cov-report=html
# 
# Parallel execution (if pytest-xdist installed):
#   pytest -n auto
# 
# Stop on first failure:
#   pytest -x
# 
# Only failed tests from last run:
#   pytest --lf
# 
# Only failed tests, then all:
#   pytest --ff
# 
# Verbose output:
#   pytest -vv
# 
# Show local variables in tracebacks:
#   pytest -l
# 
# ============================================================================
# END OF CONFIGURATION
# ============================================================================